name: CI/CD Pipeline - GenTestAI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: read
  issues: write

jobs:
  continuous-integration-and-deployment:
    runs-on: ubuntu-latest

    steps:
    # --- FASE 1: SETUP ---
    - name: üì• Checkout do C√≥digo
      uses: actions/checkout@v4

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: üì¶ Instalar Depend√™ncias
      run: npm ci

    # --- FASE 2: INTEGRIDADE (CI) ---
    - name: üèóÔ∏è Verificar Build (Compila√ß√£o)
      working-directory: ./app
      run: npm run build

    # --- FASE 3: TESTES (CI) ---
    - name: üß™ Rodar Testes Unit√°rios (TDD)
      working-directory: ./app
      run: npm test -- --run

    # --- FASE 4: QUALIDADE (Code Smell) ---
    - name: üîç Detectar C√≥digo Duplicado (jscpd)
      id: jscpd
      working-directory: ./app
      # continue-on-error j√° n√£o √© estritamente necess√°rio com o fix abaixo,
      # mas deixamos como seguran√ßa.
      continue-on-error: true
      run: |
        # 'set +e' diz ao terminal para N√ÉO abortar se o comando falhar
        set +e
        
        # Executa o jscpd e captura o c√≥digo de sa√≠da na vari√°vel exit_code
        npx jscpd src/ --reporters json --output "./report"
        exit_code=$?
        
        # 'set -e' restaura o comportamento padr√£o (abortar em erros futuros)
        set -e

        # Agora verificamos o c√≥digo de sa√≠da manualmente
        if [ $exit_code -ne 0 ]; then
          echo "‚ö†Ô∏è Duplicatas encontradas. Configurando output..."
          echo "has_smells=true" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ Nenhum c√≥digo duplicado."
          echo "has_smells=false" >> $GITHUB_OUTPUT
        fi

    # --- FASE 5: NOTIFICA√á√ÉO DETALHADA (Loop) ---
    - name: üìù Processar Duplicatas e Criar Issues
      if: steps.jscpd.outputs.has_smells == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            // 1. Ler o relat√≥rio JSON
            const reportContent = fs.readFileSync('./app/report/jscpd-report.json', 'utf8');
            const report = JSON.parse(reportContent);
            const duplicates = report.duplicates.slice(0, 15);
            
            console.log(`üîç Encontradas ${report.duplicates.length} duplica√ß√µes.`);

            // 2. Buscar TODAS as issues ABERTAS que tenham a label 'code-smell'
            // Isso evita criar duplicatas. Trazemos as 100 primeiras (suficiente para o projeto)
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'code-smell',
              per_page: 100
            });

            console.log(`üìÇ Issues abertas de smell encontradas: ${existingIssues.data.length}`);

            let issuesCreated = 0;

            for (const dupe of duplicates) {
              const fileA = dupe.firstFile;
              const fileB = dupe.secondFile;
              
              // O T√≠tulo √© nossa "Chave √önica" para identificar a duplica√ß√£o
              const title = `üö® Code Smell: Duplica√ß√£o em ${fileA.name} e ${fileB.name}`;
              
              // 3. VERIFICA√á√ÉO: A issue j√° existe na lista que baixamos?
              const alreadyExists = existingIssues.data.find(issue => issue.title === title);
              
              if (alreadyExists) {
                console.log(`‚ö†Ô∏è Issue j√° existe (PULANDO): ${title} (#${alreadyExists.number})`);
                continue; // Vai para a pr√≥xima itera√ß√£o do loop
              }

              // Se n√£o existe, monta o corpo e cria
              const body = `
              ### ‚ö†Ô∏è C√≥digo Duplicado Detectado
              
              O pipeline de CI identificou um trecho de c√≥digo id√™ntico em dois arquivos.
              
              **Arquivo 1:** \`${fileA.name}\` (Linhas: ${fileA.start}-${fileA.end})
              **Arquivo 2:** \`${fileB.name}\` (Linhas: ${fileB.start}-${fileB.end})
              
              ---
              ### üõ†Ô∏è A√ß√£o Necess√°ria
              Refatore para remover a duplica√ß√£o.
              Feche esta issue automaticamente com: \`git commit -m "refactor: fix duplication. Closes #<ID>"\`
              `;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['code-smell', 'refactor']
              });
              
              console.log(`‚úÖ Issue criada: ${title}`);
              issuesCreated++;
            }
            
            // 4. FALHAR O PIPELINE (Para bloquear o Deploy)
            core.setFailed(`üö® Pipeline Falhou: ${report.duplicates.length} duplica√ß√µes ativas. (${issuesCreated} issues novas criadas).`);
            
          } catch (error) {
            console.error(error);
            core.setFailed('Erro ao processar relat√≥rio de duplica√ß√£o.');
          }

    # --- FASE 6: ENTREGA (CD) ---
    - name: üöÄ Deploy para Vercel
      if: success()
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./app
        vercel-args: '--prod'