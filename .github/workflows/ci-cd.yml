name: CI/CD Pipeline - GenTestAI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: read
  issues: write

jobs:
  continuous-integration-and-deployment:
    runs-on: ubuntu-latest

    steps:
    # --- FASE 1: SETUP ---
    - name: ðŸ“¥ Checkout do CÃ³digo
      uses: actions/checkout@v4

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: ðŸ“¦ Instalar DependÃªncias
      run: npm ci

    # --- FASE 2: INTEGRIDADE (Bloqueante) ---
    - name: ðŸ—ï¸ Verificar Build (CompilaÃ§Ã£o)
      working-directory: ./app
      run: npm run build

    # --- FASE 3: TESTES (Bloqueante) ---
    - name: ðŸ§ª Rodar Testes UnitÃ¡rios (TDD)
      working-directory: ./app
      run: npm test -- --run

    # --- FASE 4: QUALIDADE (Apenas Aviso) ---
    - name: ðŸ” Detectar CÃ³digo Duplicado (jscpd)
      id: jscpd
      working-directory: ./app
      continue-on-error: true
      run: |
        # set +e impede que o script pare se o jscpd encontrar erros
        set +e
        
        npx jscpd src/ --reporters json --output "./report"
        exit_code=$?
        
        set -e

        if [ $exit_code -ne 0 ]; then
          echo "âš ï¸ Duplicatas encontradas. Gerando alerta..."
          echo "has_smells=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… CÃ³digo limpo."
          echo "has_smells=false" >> $GITHUB_OUTPUT
        fi

    # --- FASE 5: NOTIFICAÃ‡ÃƒO (Opcional) ---
    - name: ðŸ“ Criar Issue de Alerta (Code Smell)
      if: steps.jscpd.outputs.has_smells == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          try {
            const reportContent = fs.readFileSync('./app/report/jscpd-report.json', 'utf8');
            const report = JSON.parse(reportContent);
            const duplicates = report.duplicates.slice(0, 10); // Pega as 10 primeiras

            // Busca issues jÃ¡ abertas para evitar duplicidade de spam
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'code-smell'
            });

            for (const dupe of duplicates) {
              const title = `âš ï¸ Aviso de Qualidade: DuplicaÃ§Ã£o em ${dupe.firstFile.name}`;
              
              // Se jÃ¡ existe, pula
              if (existingIssues.data.find(i => i.title === title)) continue;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: `O pipeline detectou duplicaÃ§Ã£o de cÃ³digo. Isso nÃ£o impediu o deploy, mas deve ser corrigido futuramente.\n\nLinhas: ${dupe.firstFile.start}-${dupe.firstFile.end}`,
                labels: ['code-smell', 'wont-fix-deploy']
              });
            }
          } catch (error) {
            console.log('Erro ao processar issues, mas seguindo para deploy.');
          }

    # --- FASE 6: ENTREGA (CD) ---
    - name: ðŸš€ Deploy para Vercel
      if: success() 
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./app
        vercel-args: '--prod'