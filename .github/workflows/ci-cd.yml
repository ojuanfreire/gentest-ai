name: CI/CD Pipeline - GenTestAI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: read
  issues: write

jobs:
  continuous-integration-and-deployment:
    runs-on: ubuntu-latest

    steps:
    # --- FASE 1: SETUP ---
    - name: üì• Checkout do C√≥digo
      uses: actions/checkout@v4

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: üì¶ Instalar Depend√™ncias
      run: npm ci

    # --- FASE 2: INTEGRIDADE (CI) ---
    - name: üèóÔ∏è Verificar Build (Compila√ß√£o)
      working-directory: ./app
      run: npm run build

    # --- FASE 3: TESTES (CI) ---
    - name: üß™ Rodar Testes Unit√°rios (TDD)
      working-directory: ./app
      run: npm test -- --run

    # --- FASE 4: QUALIDADE (Code Smell) ---
    - name: üîç Detectar C√≥digo Duplicado (jscpd)
      id: jscpd
      working-directory: ./app
      # continue-on-error j√° n√£o √© estritamente necess√°rio com o fix abaixo,
      # mas deixamos como seguran√ßa.
      continue-on-error: true
      run: |
        # 'set +e' diz ao terminal para N√ÉO abortar se o comando falhar
        set +e
        
        # Executa o jscpd e captura o c√≥digo de sa√≠da na vari√°vel exit_code
        npx jscpd src/ --reporters json --output "./report"
        exit_code=$?
        
        # 'set -e' restaura o comportamento padr√£o (abortar em erros futuros)
        set -e

        # Agora verificamos o c√≥digo de sa√≠da manualmente
        if [ $exit_code -ne 0 ]; then
          echo "‚ö†Ô∏è Duplicatas encontradas. Configurando output..."
          echo "has_smells=true" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ Nenhum c√≥digo duplicado."
          echo "has_smells=false" >> $GITHUB_OUTPUT
        fi

    # --- FASE 5: NOTIFICA√á√ÉO DETALHADA (Loop) ---
    - name: üìù Processar Duplicatas e Criar Issues
      if: steps.jscpd.outputs.has_smells == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            // 1. Ler o relat√≥rio JSON gerado pelo jscpd
            const reportContent = fs.readFileSync('./app/report/jscpd-report.json', 'utf8');
            const report = JSON.parse(reportContent);
            
            // 2. Iterar sobre cada duplica√ß√£o encontrada
            // (Limitamos a 15 issues para evitar bloqueio de API do GitHub se houver muitas)
            const duplicates = report.duplicates.slice(0, 15);
            
            console.log(`Encontradas ${report.duplicates.length} duplica√ß√µes. Criando issues para as primeiras ${duplicates.length}...`);

            for (const dupe of duplicates) {
              const fileA = dupe.firstFile;
              const fileB = dupe.secondFile;
              
              // Monta um t√≠tulo descritivo
              const title = `üö® Code Smell: Duplica√ß√£o em ${fileA.name} e ${fileB.name}`;
              
              // Monta um corpo detalhado com linhas e c√≥digo
              const body = `
              ### ‚ö†Ô∏è C√≥digo Duplicado Detectado
              
              O pipeline de CI identificou um trecho de c√≥digo id√™ntico em dois arquivos.
              Isso viola o princ√≠pio DRY (Don't Repeat Yourself).
              
              **Arquivo 1:** \`${fileA.name}\` (Linhas: ${fileA.start}-${fileA.end})
              **Arquivo 2:** \`${fileB.name}\` (Linhas: ${fileB.start}-${fileB.end})
              
              ---
              
              ### üõ†Ô∏è A√ß√£o Necess√°ria
              Refatore o c√≥digo para extrair a l√≥gica comum para uma fun√ß√£o ou componente reutiliz√°vel.
              
              Para fechar esta issue automaticamente no pr√≥ximo commit, use:
              \`git commit -m "Refactor: remove duplication. Closes #<ID_DA_ISSUE>"\`
              `;

              // 3. Criar a Issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['code-smell', 'refactor']
              });
            }
            
            // 4. FALHAR O PIPELINE
            core.setFailed(`üö® Falha de Qualidade: ${report.duplicates.length} duplica√ß√µes encontradas. Issues criadas.`);
            
          } catch (error) {
            console.error(error);
            core.setFailed('Erro ao processar relat√≥rio de duplica√ß√£o.');
          }

    # --- FASE 6: ENTREGA (CD) ---
    - name: üöÄ Deploy para Vercel
      if: success()
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./app
        vercel-args: '--prod'