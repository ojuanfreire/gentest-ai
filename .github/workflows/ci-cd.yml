name: CI/CD Pipeline - GenTestAI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

permissions:
  contents: read
  issues: write

jobs:
  continuous-integration-and-deployment:
    runs-on: ubuntu-latest

    steps:
    # --- FASE 1: SETUP ---
    - name: üì• Checkout do C√≥digo
      uses: actions/checkout@v4

    - name: üü¢ Setup Node.js (v20)
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: üì¶ Instalar Depend√™ncias
      run: npm ci

    # --- FASE 2: INTEGRIDADE (Bloqueante) ---
    - name: üèóÔ∏è Verificar Build (Compila√ß√£o)
      working-directory: ./app
      run: npm run build

    # --- FASE 3: TESTES (Bloqueante) ---
    - name: üß™ Rodar Testes
      working-directory: ./app
      run: npm test -- --run

    # --- FASE 4: QUALIDADE (Apenas Aviso) ---
    - name: üîç Detectar C√≥digo Duplicado (jscpd)
      id: jscpd
      working-directory: ./app
      continue-on-error: true
      run: |
        # set +e impede que o script pare se o jscpd encontrar erros
        set +e
        
        npx jscpd src/ --reporters json --output "./report"
        exit_code=$?
        
        set -e

        if [ $exit_code -ne 0 ]; then
          echo "‚ö†Ô∏è Duplicatas encontradas. Gerando alerta..."
          echo "has_smells=true" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ C√≥digo limpo."
          echo "has_smells=false" >> $GITHUB_OUTPUT
        fi

    # --- FASE 5: NOTIFICA√á√ÉO (Opcional) ---
    - name: üìù Criar Issues de Code Smell (Sem parar o Deploy)
      if: steps.jscpd.outputs.has_smells == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            // 1. Ler o relat√≥rio JSON
            const reportContent = fs.readFileSync('./app/report/jscpd-report.json', 'utf8');
            const report = JSON.parse(reportContent);
            
            // Limita a 10 para n√£o estourar limites da API em casos extremos
            const duplicates = report.duplicates.slice(0, 10);
            
            console.log(`üîç Encontradas ${report.duplicates.length} duplica√ß√µes.`);

            // 2. Buscar issues ABERTAS de smell para evitar duplicatas
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'code-smell'
            });

            for (const dupe of duplicates) {
              const fileA = dupe.firstFile;
              const fileB = dupe.secondFile;
              
              // T√≠tulo √∫nico para identifica√ß√£o
              const title = `üö® Code Smell: Duplica√ß√£o em ${fileA.name} e ${fileB.name}`;
              
              // Se j√° existe, pula e avisa no log
              if (existingIssues.data.find(i => i.title === title)) {
                console.log(`‚ö†Ô∏è Issue j√° existe: ${title}`);
                continue;
              }

              const body = `
              ### ‚ö†Ô∏è C√≥digo Duplicado Detectado
              
              O pipeline identificou l√≥gica id√™ntica em dois arquivos diferentes.
              
              - **Arquivo 1:** \`${fileA.name}\` (Linhas: ${fileA.start} - ${fileA.end})
              - **Arquivo 2:** \`${fileB.name}\` (Linhas: ${fileB.start} - ${fileB.end})
              
              ---
              ### üõ†Ô∏è Sugest√£o
              Considere extrair essa l√≥gica para um componente ou fun√ß√£o reutiliz√°vel.
              `;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['code-smell', 'wont-fix-deploy'] // Label indica que n√£o bloqueou deploy
              });
              
              console.log(`‚úÖ Issue criada: ${title}`);
            }
            
            // REMOVIDO: core.setFailed(...)
            // O script termina com sucesso mesmo achando problemas.
            
          } catch (error) {
            console.error('Erro ao processar issues:', error);
            // N√£o falhamos o pipeline mesmo se der erro no script
          }

    # --- FASE 6: ENTREGA (CD) ---
    - name: üöÄ Deploy para Vercel
      if: success()
      uses: amondnet/vercel-action@v25 # ATUALIZA√á√ÉO: Usando vers√£o mais recente (v25)
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'